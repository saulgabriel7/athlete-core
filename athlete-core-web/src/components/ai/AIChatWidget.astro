---
/**
 * ATHLETE CORE - AI Chat Widget
 * Assistente de IA flutuante com design premium
 */

interface Props {
  userId?: string;
}

const { userId } = Astro.props;
---

<div class="ai-chat-widget" id="ai-chat-widget">
  <!-- Bot√£o flutuante -->
  <button class="chat-trigger" id="chat-trigger" aria-label="Abrir assistente">
    <div class="trigger-glow"></div>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M12 8V4H8"/>
      <rect width="16" height="12" x="4" y="8" rx="2"/>
      <path d="M2 14h2"/>
      <path d="M20 14h2"/>
      <path d="M15 13v2"/>
      <path d="M9 13v2"/>
    </svg>
    <span class="trigger-badge">AI</span>
  </button>

  <!-- Janela do chat -->
  <div class="chat-window" id="chat-window">
    <div class="chat-header">
      <div class="chat-header-info">
        <div class="chat-avatar">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 8V4H8"/>
            <rect width="16" height="12" x="4" y="8" rx="2"/>
            <path d="M2 14h2"/>
            <path d="M20 14h2"/>
            <path d="M15 13v2"/>
            <path d="M9 13v2"/>
          </svg>
        </div>
        <div class="chat-header-text">
          <span class="chat-title">ATHLETE AI</span>
          <span class="chat-status">
            <span class="status-dot"></span>
            Online
          </span>
        </div>
      </div>
      <button class="chat-close" id="chat-close" aria-label="Fechar">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M18 6 6 18"/><path d="m6 6 12 12"/>
        </svg>
      </button>
    </div>

    <div class="chat-messages" id="chat-messages">
      <div class="message ai">
        <div class="message-avatar">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 8V4H8"/>
            <rect width="16" height="12" x="4" y="8" rx="2"/>
          </svg>
        </div>
        <div class="message-content">
          Ol√°! üëã Sou o assistente do <strong>ATHLETE CORE</strong>. 
          Posso te ajudar com treinos, nutri√ß√£o e dicas de fitness. Como posso ajudar?
        </div>
      </div>
    </div>

    <div class="chat-suggestions" id="chat-suggestions">
      <button class="suggestion" data-message="Crie um treino de peito para hipertrofia">
        üí™ Treino de peito
      </button>
      <button class="suggestion" data-message="Sugira uma refei√ß√£o p√≥s-treino rica em prote√≠na">
        üçó P√≥s-treino
      </button>
      <button class="suggestion" data-message="Dicas para melhorar meu desempenho">
        üìà Dicas
      </button>
    </div>

    <form class="chat-input" id="chat-form">
      <input 
        type="text" 
        id="chat-input-field"
        placeholder="Digite sua mensagem..." 
        autocomplete="off"
      />
      <button type="submit" id="chat-send" aria-label="Enviar">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/>
        </svg>
      </button>
    </form>
  </div>
</div>

<script define:vars={{ userId }}>
  const widget = document.getElementById('ai-chat-widget');
  const trigger = document.getElementById('chat-trigger');
  const chatWindow = document.getElementById('chat-window');
  const closeBtn = document.getElementById('chat-close');
  const form = document.getElementById('chat-form');
  const input = document.getElementById('chat-input-field');
  const messagesContainer = document.getElementById('chat-messages');
  const suggestionsContainer = document.getElementById('chat-suggestions');

  let history = [];
  let isOpen = false;

  // Toggle chat
  function toggleChat() {
    isOpen = !isOpen;
    widget?.classList.toggle('open', isOpen);
    if (isOpen) {
      input?.focus();
    }
  }

  trigger?.addEventListener('click', toggleChat);
  closeBtn?.addEventListener('click', toggleChat);

  // Close on Escape
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && isOpen) {
      toggleChat();
    }
  });

  // Sugest√µes
  suggestionsContainer?.querySelectorAll('.suggestion').forEach(btn => {
    btn.addEventListener('click', () => {
      const message = btn.dataset.message;
      if (message) {
        sendMessage(message);
        suggestionsContainer.style.display = 'none';
      }
    });
  });

  // Enviar mensagem
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const message = input?.value?.trim();
    if (!message) return;
    
    input.value = '';
    suggestionsContainer.style.display = 'none';
    await sendMessage(message);
  });

  async function sendMessage(message) {
    // Adiciona mensagem do usu√°rio
    addMessage(message, 'user');
    history.push({ role: 'user', content: message });

    // Mostra indicador de digita√ß√£o
    const typingId = addTypingIndicator();

    try {
      const res = await fetch('/api/ai/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message, history, userId })
      });

      const data = await res.json();
      removeTypingIndicator(typingId);

      if (data.success) {
        addMessage(data.response, 'ai');
        history.push({ role: 'model', content: data.response });
      } else {
        addMessage('Desculpe, ocorreu um erro. Tente novamente.', 'ai error');
      }
    } catch (error) {
      removeTypingIndicator(typingId);
      addMessage('Erro de conex√£o. Verifique sua internet.', 'ai error');
    }
  }

  function addMessage(content, type) {
    const div = document.createElement('div');
    div.className = `message ${type}`;
    
    let avatarHTML = '';
    if (type.includes('ai')) {
      avatarHTML = `<div class="message-avatar">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 8V4H8"/>
          <rect width="16" height="12" x="4" y="8" rx="2"/>
        </svg>
      </div>`;
    }
    
    div.innerHTML = `${avatarHTML}<div class="message-content">${formatMessage(content)}</div>`;
    messagesContainer?.appendChild(div);
    messagesContainer?.scrollTo({ top: messagesContainer.scrollHeight, behavior: 'smooth' });
  }

  function formatMessage(text) {
    return text
      .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
      .replace(/\*(.*?)\*/g, '<em>$1</em>')
      .replace(/\n/g, '<br>')
      .replace(/- (.*?)(<br>|$)/g, '‚Ä¢ $1$2');
  }

  function addTypingIndicator() {
    const id = 'typing-' + Date.now();
    const div = document.createElement('div');
    div.id = id;
    div.className = 'message ai typing';
    div.innerHTML = `
      <div class="message-avatar">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 8V4H8"/>
          <rect width="16" height="12" x="4" y="8" rx="2"/>
        </svg>
      </div>
      <div class="message-content">
        <span class="dot"></span>
        <span class="dot"></span>
        <span class="dot"></span>
      </div>
    `;
    messagesContainer?.appendChild(div);
    messagesContainer?.scrollTo({ top: messagesContainer.scrollHeight, behavior: 'smooth' });
    return id;
  }

  function removeTypingIndicator(id) {
    document.getElementById(id)?.remove();
  }
</script>

<style>
  .ai-chat-widget {
    position: fixed;
    bottom: 24px;
    right: 24px;
    z-index: 1000;
    font-family: var(--font-sans);
  }

  /* Bot√£o flutuante */
  .chat-trigger {
    width: 60px;
    height: 60px;
    border-radius: var(--radius-full);
    background: var(--color-accent);
    color: var(--color-black);
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    transition: all var(--transition-fast);
    box-shadow: 0 4px 20px var(--color-accent-glow);
  }

  .trigger-glow {
    position: absolute;
    inset: -4px;
    border-radius: inherit;
    background: var(--color-accent);
    opacity: 0.3;
    filter: blur(12px);
    z-index: -1;
    animation: glow-pulse 2s ease-in-out infinite;
  }

  @keyframes glow-pulse {
    0%, 100% { opacity: 0.3; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(1.05); }
  }

  .chat-trigger:hover {
    transform: scale(1.1);
    box-shadow: 0 8px 30px var(--color-accent-glow);
  }

  .trigger-badge {
    position: absolute;
    bottom: -2px;
    right: -2px;
    font-size: 9px;
    font-weight: var(--font-weight-bold);
    background: var(--color-black);
    color: var(--color-accent);
    padding: 2px 6px;
    border-radius: var(--radius-sm);
    letter-spacing: var(--letter-spacing-wide);
  }

  .ai-chat-widget.open .chat-trigger {
    display: none;
  }

  /* Janela do chat */
  .chat-window {
    display: none;
    width: 400px;
    height: 560px;
    background: var(--color-background);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-xl);
    box-shadow: 0 16px 48px rgba(0, 0, 0, 0.4);
    flex-direction: column;
    overflow: hidden;
    animation: slideUp var(--transition-base) ease-out;
  }

  @keyframes slideUp {
    from {
      opacity: 0;
      transform: translateY(20px) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  .ai-chat-widget.open .chat-window {
    display: flex;
  }

  /* Header */
  .chat-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--spacing-md) var(--spacing-lg);
    background: var(--color-background-elevated);
    border-bottom: 1px solid var(--color-border);
  }

  .chat-header-info {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
  }

  .chat-avatar {
    width: 40px;
    height: 40px;
    background: var(--color-accent-muted);
    border: 1px solid rgba(196, 255, 59, 0.2);
    border-radius: var(--radius-lg);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-accent);
  }

  .chat-header-text {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .chat-title {
    font-weight: var(--font-weight-semibold);
    font-size: var(--font-size-sm);
    color: var(--color-foreground);
    letter-spacing: var(--letter-spacing-wide);
  }

  .chat-status {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 11px;
    color: var(--color-success);
  }

  .status-dot {
    width: 6px;
    height: 6px;
    background: var(--color-success);
    border-radius: var(--radius-full);
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }

  .chat-close {
    background: var(--color-background);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    color: var(--color-foreground-muted);
    cursor: pointer;
    padding: var(--spacing-xs);
    transition: all var(--transition-fast);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .chat-close:hover {
    background: var(--color-error);
    border-color: var(--color-error);
    color: white;
  }

  /* Messages */
  .chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: var(--spacing-md);
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
    background: var(--color-background);
  }

  .message {
    display: flex;
    gap: var(--spacing-sm);
    max-width: 90%;
    animation: fadeIn var(--transition-fast) ease-out;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .message.user {
    align-self: flex-end;
    flex-direction: row-reverse;
  }

  .message.ai {
    align-self: flex-start;
  }

  .message-avatar {
    width: 28px;
    height: 28px;
    background: var(--color-accent-muted);
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-accent);
    flex-shrink: 0;
  }

  .message-content {
    padding: var(--spacing-sm) var(--spacing-md);
    border-radius: var(--radius-lg);
    font-size: var(--font-size-sm);
    line-height: var(--line-height-relaxed);
  }

  .message.user .message-content {
    background: var(--color-accent);
    color: var(--color-black);
    border-bottom-right-radius: var(--radius-sm);
  }

  .message.ai .message-content {
    background: var(--color-background-elevated);
    border: 1px solid var(--color-border);
    color: var(--color-foreground);
    border-bottom-left-radius: var(--radius-sm);
  }

  .message.error .message-content {
    background: rgba(239, 68, 68, 0.1);
    border-color: rgba(239, 68, 68, 0.3);
    color: var(--color-error);
  }

  /* Typing indicator */
  .message.typing .message-content {
    display: flex;
    gap: 4px;
    padding: var(--spacing-md);
  }

  .dot {
    width: 8px;
    height: 8px;
    background: var(--color-accent);
    border-radius: var(--radius-full);
    animation: bounce 1.4s infinite ease-in-out;
  }

  .dot:nth-child(1) { animation-delay: 0s; }
  .dot:nth-child(2) { animation-delay: 0.2s; }
  .dot:nth-child(3) { animation-delay: 0.4s; }

  @keyframes bounce {
    0%, 80%, 100% { transform: translateY(0); }
    40% { transform: translateY(-8px); }
  }

  /* Suggestions */
  .chat-suggestions {
    display: flex;
    gap: var(--spacing-sm);
    padding: var(--spacing-sm) var(--spacing-md);
    overflow-x: auto;
    background: var(--color-background);
    border-top: 1px solid var(--color-border);
  }

  .suggestion {
    flex-shrink: 0;
    padding: var(--spacing-sm) var(--spacing-md);
    font-size: var(--font-size-xs);
    font-family: inherit;
    background: var(--color-background-elevated);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-full);
    cursor: pointer;
    transition: all var(--transition-fast);
    white-space: nowrap;
    color: var(--color-foreground-muted);
  }

  .suggestion:hover {
    background: var(--color-accent);
    color: var(--color-black);
    border-color: var(--color-accent);
    transform: translateY(-2px);
  }

  /* Input */
  .chat-input {
    display: flex;
    gap: var(--spacing-sm);
    padding: var(--spacing-md);
    background: var(--color-background-elevated);
    border-top: 1px solid var(--color-border);
  }

  .chat-input input {
    flex: 1;
    padding: var(--spacing-sm) var(--spacing-md);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    font-size: var(--font-size-sm);
    background: var(--color-background);
    color: var(--color-foreground);
    transition: all var(--transition-fast);
  }

  .chat-input input:focus {
    outline: none;
    border-color: var(--color-accent);
    box-shadow: 0 0 0 3px var(--color-accent-muted);
  }

  .chat-input input::placeholder {
    color: var(--color-foreground-subtle);
  }

  .chat-input button[type="submit"] {
    width: 44px;
    height: 44px;
    background: var(--color-accent);
    color: var(--color-black);
    border: none;
    border-radius: var(--radius-lg);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition-fast);
  }

  .chat-input button[type="submit"]:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px var(--color-accent-glow);
  }

  /* Mobile */
  @media (max-width: 480px) {
    .ai-chat-widget {
      bottom: 16px;
      right: 16px;
    }

    .chat-window {
      position: fixed;
      bottom: 0;
      right: 0;
      left: 0;
      width: 100%;
      height: 100%;
      max-height: 100vh;
      border-radius: 0;
    }
  }
</style>
