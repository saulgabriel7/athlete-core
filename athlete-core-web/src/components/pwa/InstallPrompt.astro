---
/**
 * ATHLETE CORE - PWA Install Prompt
 * Banner para instalar o app
 */
---

<div class="install-prompt" id="install-prompt">
  <div class="install-content">
    <div class="install-icon">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
        <polyline points="7 10 12 15 17 10"/>
        <line x1="12" x2="12" y1="15" y2="3"/>
      </svg>
    </div>
    <div class="install-text">
      <strong>Instalar ATHLETE CORE</strong>
      <span>Adicione à sua tela inicial para acesso rápido</span>
    </div>
  </div>
  <div class="install-actions">
    <button class="install-btn" id="install-btn">Instalar</button>
    <button class="close-btn" id="close-install" aria-label="Fechar">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M18 6 6 18"/><path d="m6 6 12 12"/>
      </svg>
    </button>
  </div>
</div>

<script>
  let deferredPrompt: any;
  const prompt = document.getElementById('install-prompt');
  const installBtn = document.getElementById('install-btn');
  const closeBtn = document.getElementById('close-install');

  // Verifica se já está instalado ou foi dispensado
  const isInstalled = window.matchMedia('(display-mode: standalone)').matches;
  const wasDismissed = localStorage.getItem('pwa-install-dismissed');

  if (isInstalled || wasDismissed) {
    prompt?.remove();
  }

  // Captura o evento de instalação
  window.addEventListener('beforeinstallprompt', (e: Event) => {
    e.preventDefault();
    deferredPrompt = e;
    
    // Mostra o prompt após 5 segundos na página
    setTimeout(() => {
      if (prompt && !isInstalled && !wasDismissed) {
        prompt.classList.add('visible');
      }
    }, 5000);
  });

  // Instala o app
  installBtn?.addEventListener('click', async () => {
    if (!deferredPrompt) return;
    
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    
    if (outcome === 'accepted') {
      console.log('PWA installed');
    }
    
    deferredPrompt = null;
    prompt?.classList.remove('visible');
  });

  // Fecha o prompt
  closeBtn?.addEventListener('click', () => {
    prompt?.classList.remove('visible');
    localStorage.setItem('pwa-install-dismissed', 'true');
  });

  // Detecta instalação bem-sucedida
  window.addEventListener('appinstalled', () => {
    console.log('PWA was installed');
    prompt?.remove();
  });
</script>

<style>
  .install-prompt {
    position: fixed;
    bottom: 24px;
    left: 24px;
    right: 24px;
    max-width: 480px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--spacing-md);
    padding: var(--spacing-md) var(--spacing-lg);
    background: var(--color-background-elevated);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-xl);
    z-index: 999;
    opacity: 0;
    transform: translateY(100%);
    pointer-events: none;
    transition: all var(--transition-base);
  }

  .install-prompt.visible {
    opacity: 1;
    transform: translateY(0);
    pointer-events: all;
  }

  .install-content {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    flex: 1;
  }

  .install-icon {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-accent-muted);
    border-radius: var(--radius-lg);
    color: var(--color-accent);
    flex-shrink: 0;
  }

  .install-text {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .install-text strong {
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-semibold);
    color: var(--color-foreground);
  }

  .install-text span {
    font-size: var(--font-size-xs);
    color: var(--color-foreground-muted);
  }

  .install-actions {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
  }

  .install-btn {
    padding: var(--spacing-sm) var(--spacing-md);
    background: var(--color-accent);
    color: var(--color-black);
    border: none;
    border-radius: var(--radius-md);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-semibold);
    font-family: inherit;
    cursor: pointer;
    transition: all var(--transition-fast);
    white-space: nowrap;
  }

  .install-btn:hover {
    background: var(--color-accent-hover);
    transform: translateY(-1px);
  }

  .close-btn {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    color: var(--color-foreground-muted);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .close-btn:hover {
    background: var(--color-background);
    color: var(--color-foreground);
  }

  @media (max-width: 480px) {
    .install-prompt {
      left: 12px;
      right: 12px;
      bottom: 12px;
      padding: var(--spacing-sm) var(--spacing-md);
    }

    .install-text span {
      display: none;
    }
  }
</style>

